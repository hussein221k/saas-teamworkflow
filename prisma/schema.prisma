generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==============================
// Enums
// ==============================

enum role {
  ADMIN
  EMPLOYEE
}

enum task_status {
  PENDING
  IN_PROGRESS
  DONE
  OVERDUE
}

enum plan {
  FREE
  PRO
  ENTERPRISE
}

enum billing_status {
  ACTIVE
  EXPIRED
  CANCELED
}

// ==============================
// user
// ==============================

model user {
  id            String  @id @default(uuid())
  name          String
  email         String? @unique
  username      String? @unique
  employee_code String? @unique
  password      String
  role          role    @default(EMPLOYEE)

  is_billing    Boolean
  billing_type  plan?
  team_id       String?
  created_by_id String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  billing_day    DateTime?
  billing_finish DateTime?

  team        team?  @relation("TeamMembers", fields: [team_id], references: [id])
  owned_teams team[] @relation("TeamOwner")

  created_by    user?  @relation("UserCreator", fields: [created_by_id], references: [id])
  created_users user[] @relation("UserCreator")

  tasks_created  task[] @relation("CreatedTasks")
  tasks_assigned task[] @relation("AssignedTasks")

  comments          comment[]
  messages_sent     message[] @relation("SentMessages")
  messages_received message[] @relation("ReceivedMessages")

  @@map("users")
}

// ==============================
// team
// ==============================

model team {
  id         String   @id @default(uuid())
  name       String
  owner_id   String
  created_at DateTime @default(now())

  owner user   @relation("TeamOwner", fields: [owner_id], references: [id])
  users user[] @relation("TeamMembers")

  billing billing?

  tasks    task[]
  messages message[]
  channels channel[]
  projects project[]

  theme_color String  @default("#6366f1")
  invite_code String? @unique

  @@map("teams")
}

// ==============================
// billing
// ==============================

model billing {
  id         String         @id @default(uuid())
  team_id    String         @unique
  plan       plan           @default(FREE)
  status     billing_status @default(ACTIVE)
  started_at DateTime       @default(now())
  ends_at    DateTime?

  team team @relation(fields: [team_id], references: [id], onDelete: Restrict)

  @@map("billings")
}

// ==============================
// project
// ==============================

model project {
  id         String   @id @default(uuid())
  name       String
  team_id    String
  created_at DateTime @default(now())

  team team @relation(fields: [team_id], references: [id])

  @@map("projects")
}

// ==============================
// channel
// ==============================

model channel {
  id         String   @id @default(uuid())
  name       String
  team_id    String
  created_at DateTime @default(now())

  team     team      @relation(fields: [team_id], references: [id])
  messages message[]

  @@map("channels")
}

// ==============================
// task
// ==============================

model task {
  id          String      @id @default(uuid())
  title       String
  description String
  status      task_status @default(PENDING)
  deadline    DateTime?

  team_id        String
  created_by_id  String
  assigned_to_id String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  team team @relation(fields: [team_id], references: [id])

  created_by  user  @relation("CreatedTasks", fields: [created_by_id], references: [id])
  assigned_to user? @relation("AssignedTasks", fields: [assigned_to_id], references: [id])

  comments comment[]

  @@map("tasks")
}

// ==============================
// comment
// ==============================

model comment {
  id      String @id @default(uuid())
  content String

  task_id String
  user_id String

  created_at DateTime @default(now())

  task task @relation(fields: [task_id], references: [id])
  user user @relation(fields: [user_id], references: [id])

  @@map("comments")
}

// ==============================
// message
// ==============================

model message {
  id      String @id @default(uuid())
  content String

  channel_id  String?
  receiver_id String?
  team_id     String
  user_id     String

  created_at DateTime @default(now())

  channel  channel? @relation(fields: [channel_id], references: [id])
  receiver user?    @relation("ReceivedMessages", fields: [receiver_id], references: [id])
  team     team     @relation(fields: [team_id], references: [id])
  user     user     @relation("SentMessages", fields: [user_id], references: [id])

  @@map("messages")
}
